info:
  name: forgame-api2
  description: 4game REST API v2
  version: 2.0
  category: service/http
  owner:
    name: Dmitry Kulikov
    email: kulikov.dm@gmail.com

include:
  - samza-task:
      mem: { qa: 256, live: 1024 }

notify:
  - slack: alert-api2

ci:
  branches:
    - master
    - featured: "^feature-(<feature>.*)$"

build:
  - shell: "mkdir -p target/pack && touch target/pack/index.txt"
  - marathon:
      marathon-host: { qa: mesos1-q.qa.inn.ru, live: ach1-lc.lux.inn.eu }
      package: target/pack

deploy:
  type: site

  routes:
    - host: { qa: api.4gametest.com, live: api.4game.com }
      location: /v2/
    - host: { qa: api2.4gametest.com, live: api2.4game.com }
    - host: { qa: go.4gametest.com, live: go.4game.com }

    - host: "{{ feature }}-api2.4gametest.com"
      location: /some-location/
      featured: true

  marathon:
    instances: { qa: 1, live: 4 }
    mem: { qa: 256, live: 1024 }
    cpu: { qa: 0.2, live: 3 }

monitoring:
  alerts:
    - name: RPS
      graphite:
        metric: sumSeries(inn.*.kidzania.api.http.timer.all.m5_rate)
        warn.max: 3000
        crit.max: 4000

    - name: Request time
      graphite:
        metric: averageSeries(inn.*.kidzania.api.http.timer.all.p75)
        warn.max: { live: 15 }
        crit.max: { live: 30 }

    - name: Errors rate
      elastic:
        query: tag:"kidzania-api" AND level:ERROR
        from: 10min
        warn: 1
        crit: 10
