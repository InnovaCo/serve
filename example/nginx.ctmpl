{{- range ls "services/routes"}}{{range service .Key}}{{end}}{{end -}}

{{- with $data := plugin "serve" "consul" "nginx-template-context" | parseJSON}}

{{range $upstream, $addresses := $data.upstreams}}
upstream {{$upstream}} {
  {{- range $addr := $addresses}}
    server {{$addr.address}}:{{$addr.port}};
  {{- end}}
}
{{end}}

{{range $host, $locations := $data.servers}}
server {
  listen 80;
  server_name {{$host}};

  {{range $location, $ups := $locations}}
  location {{$location}} {
    {{- if $ups.stage}}
      if ($staging = "stage") {
        proxy_pass http://{{$ups.stage}}/;
      }

      {{- if $ups.live}}
      if ($staging = "live") {
          proxy_pass http://{{$ups.live}}/;
      }
      {{- end}}
    {{- else}}
      proxy_pass http://{{$ups.live}}/;
    {{- end}}
  }
  {{end}}
}
{{end}}
{{- end}}
